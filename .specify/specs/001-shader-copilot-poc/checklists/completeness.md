# 需求完整性检查清单

**用途**: 验证规格文档的需求完整性，用于实现前的最终检查  
**创建时间**: 2025-12-28  
**关注点**: 需求完整性 + 缺失项检测（错误处理、恢复流程、边界情况）

---

## 需求完整性

### 用户故事覆盖

- [ ] CHK001 - US1（文本生成）的所有验收场景是否覆盖了成功路径、失败路径和边界情况？ [完整性, Spec §US1]
- [ ] CHK002 - US2（图片分析）是否定义了当 VL 模型返回模糊分析结果时的处理需求？ [Gap, Spec §US2]
- [ ] CHK003 - US3（效果迭代）是否明确了"修改 Shader"的范围限制？例如用户说"重新做一个"应如何处理？ [Gap, Spec §US3]
- [ ] CHK004 - US4（会话管理）是否定义了会话数据的最大存储量或过期策略？ [Gap, Spec §US4]
- [ ] CHK005 - US5（预览配置）是否明确了所有支持的预览物体类型和背景类型的完整列表？ [完整性, Spec §US5]

### 功能需求覆盖

- [ ] CHK006 - FR-003（流式显示）是否定义了流式传输中断时的 UI 行为？ [Gap]
- [ ] CHK007 - FR-004（对话上下文）是否定义了上下文窗口大小限制？当历史过长时如何处理？ [Gap]
- [ ] CHK008 - FR-007（自动编译）是否明确了编译超时的时间阈值和超时后的处理方式？ [Gap]
- [ ] CHK009 - FR-008（自动重试）是否区分了不同类型的编译错误（语法错误 vs 语义错误）的重试策略？ [清晰度, Spec §错误处理]
- [ ] CHK010 - FR-011（截图功能）是否定义了截图的分辨率、格式和存储位置？ [Gap]
- [ ] CHK011 - FR-016（自动启动后端）是否定义了后端启动失败时的用户提示和重试机制？ [Gap]
- [ ] CHK012 - FR-017（后端生命周期）是否定义了 Unity 崩溃后后端进程的清理策略？ [Gap]
- [ ] CHK013 - FR-018（WebSocket 通信）是否定义了消息队列溢出时的处理策略？ [Gap]

---

## 错误处理与恢复

### 网络与连接

- [ ] CHK014 - 是否定义了 WebSocket 连接建立失败的重试间隔和最大重试次数？ [Gap]
- [ ] CHK015 - 是否定义了连接恢复后如何同步丢失的状态？例如正在执行的任务如何恢复？ [Gap]
- [ ] CHK016 - SC-006 提到"10秒内自动恢复连接"，但是否定义了连续多次恢复失败后的降级策略？ [Gap, Spec §SC-006]

### LLM 服务

- [ ] CHK017 - Edge Cases 提到"LLM 服务不可用"，但是否定义了部分模型不可用时的降级策略？例如 VL 模型挂了但文本模型可用 [Gap, Edge Cases]
- [ ] CHK018 - 是否定义了 LLM 响应超时的具体时间阈值？ [Gap]
- [ ] CHK019 - 是否定义了 LLM 返回格式异常（非预期 JSON、乱码等）时的处理？ [Gap]
- [ ] CHK020 - 是否定义了 LLM API 限流（rate limit）时的处理策略？ [Gap]

### Shader 编译

- [ ] CHK021 - 是否定义了 Shader 编译过程中 Unity Editor 卡顿的预防措施？ [Gap]
- [ ] CHK022 - 是否定义了 Shader 编译导致 Unity 崩溃后的会话恢复机制？ [Gap]
- [ ] CHK023 - 重试 3 次后询问用户，但是否定义了用户选择"继续尝试"后的具体行为？无限重试还是再给 3 次？ [Gap, Spec §错误处理]

### 文件操作

- [ ] CHK024 - FR-015 提到覆盖前询问确认，但是否定义了目标目录不存在时是否自动创建？ [Gap]
- [ ] CHK025 - 是否定义了文件保存失败（磁盘满、权限不足等）时的用户提示和恢复选项？ [Gap]
- [ ] CHK026 - 是否定义了保存过程中 Unity 崩溃后的临时文件清理策略？ [Gap]

---

## 边界情况

### 输入边界

- [ ] CHK027 - 是否定义了用户输入文本的最大长度限制？ [Gap]
- [ ] CHK028 - 是否定义了上传图片的最大尺寸和文件大小限制？ [Gap]
- [ ] CHK029 - Edge Cases 提到"描述过于模糊"，但是否定义了判断标准？谁来判断、如何判断？ [清晰度, Edge Cases]
- [ ] CHK030 - 是否定义了用户同时发送多条消息时的处理（队列还是拒绝）？ [Gap]

### 输出边界

- [ ] CHK031 - 是否定义了生成的 Shader 代码的最大长度限制？ [Gap]
- [ ] CHK032 - 是否定义了单次会话中可生成的 Shader/材质数量限制？ [Gap]
- [ ] CHK033 - 是否定义了预览场景中材质属性值的有效范围验证？ [Gap]

### 并发与状态

- [ ] CHK034 - 是否定义了用户在 Shader 生成过程中发送新消息时的处理？取消当前任务还是排队？ [Gap]
- [ ] CHK035 - 是否定义了用户在确认对话框显示期间继续操作的行为？ [Gap]
- [ ] CHK036 - 是否定义了多个 Unity Editor 窗口同时打开 ShaderCopilot 时的行为？ [Gap]

---

## 数据完整性

### 会话持久化

- [ ] CHK037 - data-model.md 定义了 Session 实体，但是否明确了 JSON 文件损坏时的恢复策略？ [Gap, data-model.md]
- [ ] CHK038 - 是否定义了会话历史的备份机制？ [Gap]
- [ ] CHK039 - 是否定义了跨 Unity 项目的会话隔离策略？ [Gap]

### 资产引用

- [ ] CHK040 - MaterialAsset 引用 ShaderAsset，是否定义了 Shader 被删除后材质的处理？ [Gap, data-model.md]
- [ ] CHK041 - Message 的 artifacts 字段引用资产路径，是否定义了资产被移动/重命名后的处理？ [Gap, data-model.md]

---

## 协议完整性

### WebSocket 消息

- [ ] CHK042 - contracts/ 定义了 6 种 Client→Server 消息，是否覆盖了所有用户操作场景？ [完整性, contracts/]
- [ ] CHK043 - 是否定义了消息 ID 冲突时的处理？ [Gap, contracts/]
- [ ] CHK044 - 是否定义了消息顺序错乱时的处理（如 TOOL_RESPONSE 先于 TOOL_CALL 到达）？ [Gap, contracts/]
- [ ] CHK045 - PING/PONG 心跳是否定义了超时判定的时间阈值？ [Gap, contracts/]

### Tool 调用

- [ ] CHK046 - Tools 定义了 17 个工具，但 PoC 范围内实际需要哪些工具是否明确？ [清晰度, Spec §Tools]
- [ ] CHK047 - 是否定义了 Tool 调用超时的时间阈值和超时后的处理？ [Gap]
- [ ] CHK048 - 是否定义了 Unity Tool 返回异常数据时后端的容错处理？ [Gap]

---

## 非功能需求

### 性能

- [ ] CHK049 - SC-001 提到"60秒内完成"，是否定义了各阶段（生成/编译/预览）的时间分配？ [清晰度, Spec §SC-001]
- [ ] CHK050 - 是否定义了 WebSocket 消息的最大大小限制？ [Gap]
- [ ] CHK051 - 是否定义了预览场景渲染的帧率要求？ [Gap]

### 安全

- [ ] CHK052 - 是否定义了生成的 Shader 代码的安全验证（防止恶意代码）？ [Gap]
- [ ] CHK053 - 是否定义了会话数据的访问控制？ [Gap]
- [ ] CHK054 - 是否定义了 LLM API Key 的存储安全要求？ [Gap]

### 可观测性

- [ ] CHK055 - 是否定义了日志记录的级别、格式和存储位置？ [Gap]
- [ ] CHK056 - 是否定义了关键操作（生成、编译、保存）的审计日志需求？ [Gap]

---

## 歧义与冲突

- [ ] CHK057 - Spec 中"用户指定目录"出现多次，是否明确了是全局配置还是每次保存时指定？ [歧义, Spec §FR-013/021]
- [ ] CHK058 - "Router Agent" 和 "Router Model" 是否指同一概念？需要澄清术语一致性 [歧义, Spec §架构]
- [ ] CHK059 - TextureGenGraph 和 ShaderAnalysisGraph 标记为"PoC 后续"，但 Tools 列表中包含相关工具，是否需要在 PoC 中实现桩函数？ [冲突, Spec §Tools vs Out of Scope]
- [ ] CHK060 - 错误处理策略提到"Agent 自主判断"重试类型，但 Router Agent 的职责是路由而非错误处理，职责边界是否清晰？ [歧义, Spec §错误处理]

---

## 摘要

| 类别 | 检查项数量 |
|------|-----------|
| 需求完整性 | 13 |
| 错误处理与恢复 | 13 |
| 边界情况 | 10 |
| 数据完整性 | 5 |
| 协议完整性 | 7 |
| 非功能需求 | 8 |
| 歧义与冲突 | 4 |
| **总计** | **60** |

### 按严重程度分类

- **[Gap]** - 缺失的需求: 42 项 → **PoC 阶段暂不处理**
- **[完整性]** - 需要验证的覆盖范围: 4 项  
- **[清晰度]** - 需要更明确定义: 6 项
- **[歧义]** - 需要澄清的术语/概念: 4 项
- **[冲突]** - 需要解决的矛盾: 1 项
- **其他追溯引用**: 3 项

---

## PoC 阶段决策

> **决策**: 标记为 [Gap] 的 42 项缺失需求在 PoC 阶段暂不处理。
> 
> **理由**: PoC 目标是验证核心技术可行性（AI 生成 Shader、自动编译、预览），完善的错误处理、边界验证、安全审计等属于产品化阶段的工作。
> 
> **后续**: 如 PoC 验证成功，在正式产品规格中补充这些需求。
